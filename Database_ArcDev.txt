# ğŸ—„ï¸ DATABASE ARCHITECTURE CHO MANGA PLATFORM

## Tá»•ng quan Chiáº¿n lÆ°á»£c Database

### NguyÃªn táº¯c Thiáº¿t káº¿

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         DATABASE DESIGN PRINCIPLES                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  1. SEPARATION OF CONCERNS (TÃ¡ch biá»‡t má»‘i quan tÃ¢m)                         â”‚
â”‚     â”œâ”€â”€ Metadata (PostgreSQL): Users, Series, Chapters info                 â”‚
â”‚     â”œâ”€â”€ Content URLs (PostgreSQL + CDN): Image paths, khÃ´ng lÆ°u binary      â”‚
â”‚     â”œâ”€â”€ Hot Data (Redis): View counts, rankings, sessions                   â”‚
â”‚     â””â”€â”€ Files (S3/MinIO): Actual images                                     â”‚
â”‚                                                                              â”‚
â”‚  2. READ-HEAVY OPTIMIZATION (90% Read, 10% Write)                           â”‚
â”‚     â”œâ”€â”€ Denormalization cÃ³ chá»n lá»c                                          â”‚
â”‚     â”œâ”€â”€ Materialized views cho rankings                                      â”‚
â”‚     â””â”€â”€ Caching layers                                                       â”‚
â”‚                                                                              â”‚
â”‚  3. SCALABILITY FIRST                                                        â”‚
â”‚     â”œâ”€â”€ UUID thay vÃ¬ auto-increment (distributed-friendly)                  â”‚
â”‚     â”œâ”€â”€ Soft delete thay vÃ¬ hard delete                                      â”‚
â”‚     â””â”€â”€ Audit trails cho má»i thay Ä‘á»•i                                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 1. CORE ENTITIES (Thá»±c thá»ƒ Cá»‘t lÃµi)

### 1.1 Users & Authentication

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              USERS DOMAIN                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   users     â”‚â”€â”€1: Nâ”€â”‚user_profilesâ”‚      â”‚ user_stats  â”‚                  â”‚
â”‚  â”‚             â”‚      â”‚  (optional) â”‚      â”‚ (denorm)    â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â”‚ 1:N                                                                â”‚
â”‚         â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚user_sessionsâ”‚      â”‚oauth_accountsâ”‚                                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Table:  `users`** (Core user identity)
| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `email` | VARCHAR(255) | Unique, indexed |
| `username` | VARCHAR(50) | Unique, indexed, URL-safe |
| `password_hash` | VARCHAR(255) | bcrypt hash, NULL náº¿u OAuth only |
| `role` | ENUM | 'reader', 'uploader', 'translator', 'moderator', 'admin' |
| `status` | ENUM | 'active', 'suspended', 'banned', 'deleted' |
| `email_verified_at` | TIMESTAMP | NULL náº¿u chÆ°a verify |
| `created_at` | TIMESTAMP | |
| `updated_at` | TIMESTAMP | |
| `last_login_at` | TIMESTAMP | |

**Táº¡i sao tÃ¡ch `user_profiles`?**
- `users` table Ä‘Æ°á»£c query Ráº¤T NHIá»€U (má»—i request check auth)
- Profile data (bio, avatar, social links) Ã­t khi cáº§n
- Giá»¯ `users` table nhá» gá»n â†’ faster queries

**Table: `user_profiles`** (Extended info)
| Column | Type | Description |
|--------|------|-------------|
| `user_id` | UUID | FK â†’ users, Primary key |
| `display_name` | VARCHAR(100) | TÃªn hiá»ƒn thá»‹ |
| `avatar_url` | TEXT | CDN URL |
| `cover_url` | TEXT | Banner cÃ¡ nhÃ¢n |
| `bio` | TEXT | Giá»›i thiá»‡u báº£n thÃ¢n |
| `website` | VARCHAR(255) | |
| `social_links` | JSONB | {"facebook": "...", "twitter": "..."} |
| `preferences` | JSONB | {"theme": "dark", "language": "vi"} |
| `updated_at` | TIMESTAMP | |

**Table: `user_stats`** (Denormalized counters - cáº­p nháº­t async)
| Column | Type | Description |
|--------|------|-------------|
| `user_id` | UUID | FK â†’ users, Primary key |
| `followers_count` | INTEGER | |
| `following_count` | INTEGER | |
| `uploads_count` | INTEGER | Sá»‘ series Ä‘Ã£ upload |
| `chapters_count` | INTEGER | Sá»‘ chapters Ä‘Ã£ dá»‹ch |
| `total_views` | BIGINT | Tá»•ng views cÃ¡c content |
| `reputation_score` | INTEGER | Äiá»ƒm uy tÃ­n |
| `level` | INTEGER | Level ngÆ°á»i dÃ¹ng |
| `exp_points` | INTEGER | Kinh nghiá»‡m |
| `updated_at` | TIMESTAMP | |

**Táº¡i sao dÃ¹ng `user_stats` riÃªng?**
```
Váº¥n Ä‘á»:  UPDATE users SET followers_count = followers_count + 1
        â†’ Lock row â†’ Bottleneck khi 1000 ngÆ°á»i follow cÃ¹ng lÃºc

Giáº£i phÃ¡p: 
â”œâ”€â”€ Redis INCR user:{id}: followers (real-time)
â”œâ”€â”€ Cronjob sync Redis â†’ user_stats má»—i 5 phÃºt
â””â”€â”€ user_stats khÃ´ng lock users table
```

---

### 1.2 Series (Manga/Manhwa/Manhua)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              SERIES DOMAIN                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   series    â”‚â”€â”€1:Nâ”€â”‚series_genresâ”‚â”€â”€N:1â”€â”‚   genres    â”‚                  â”‚
â”‚  â”‚             â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚  â”‚             â”‚                                                             â”‚
â”‚  â”‚             â”‚â”€â”€1:Nâ”€â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚  â”‚             â”‚      â”‚series_tags  â”‚â”€â”€N:1â”€â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚             â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚    tags     â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â”‚ 1:1                                                                â”‚
â”‚         â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚series_stats â”‚      â”‚series_alt   â”‚      â”‚series_staff â”‚                  â”‚
â”‚  â”‚ (denorm)    â”‚      â”‚_titles      â”‚      â”‚(author,artist)â”‚                â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Table: `series`** (Core manga info)
| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `title` | VARCHAR(255) | TÃªn chÃ­nh (display) |
| `slug` | VARCHAR(255) | URL-safe, unique, indexed |
| `type` | ENUM | 'manga', 'manhwa', 'manhua', 'comic', 'webtoon' |
| `status` | ENUM | 'ongoing', 'completed', 'hiatus', 'cancelled', 'upcoming' |
| `country` | VARCHAR(2) | 'JP', 'KR', 'CN', 'VN', etc. (ISO code) |
| `year` | SMALLINT | NÄƒm phÃ¡t hÃ nh |
| `description` | TEXT | MÃ´ táº£/tÃ³m táº¯t |
| `cover_url` | TEXT | áº¢nh bÃ¬a chÃ­nh |
| `banner_url` | TEXT | Banner (optional) |
| `is_nsfw` | BOOLEAN | 18+ content |
| `is_licensed` | BOOLEAN | CÃ³ báº£n quyá»n official |
| `uploader_id` | UUID | FK â†’ users (ngÆ°á»i Ä‘Äƒng Ä‘áº§u tiÃªn) |
| `visibility` | ENUM | 'public', 'private', 'unlisted' |
| `created_at` | TIMESTAMP | |
| `updated_at` | TIMESTAMP | |
| `published_at` | TIMESTAMP | Khi nÃ o public láº§n Ä‘áº§u |

**Table: `series_alt_titles`** (TÃªn thay tháº¿ - quan trá»ng cho search)
| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `series_id` | UUID | FK â†’ series |
| `title` | VARCHAR(255) | TÃªn thay tháº¿ |
| `language` | VARCHAR(5) | 'ja', 'ko', 'zh', 'en', 'vi' |
| `is_primary` | BOOLEAN | TÃªn chÃ­nh cá»§a ngÃ´n ngá»¯ Ä‘Ã³ |

**Táº¡i sao cáº§n `series_alt_titles`?**
```
One Piece cÃ³ thá»ƒ Ä‘Æ°á»£c tÃ¬m báº±ng: 
â”œâ”€â”€ "One Piece" (English)
â”œâ”€â”€ "ãƒ¯ãƒ³ãƒ”ãƒ¼ã‚¹" (Japanese)
â”œâ”€â”€ "ì›í”¼ìŠ¤" (Korean)
â”œâ”€â”€ "Äáº£o Háº£i Táº·c" (Vietnamese)
â””â”€â”€ "Vua Háº£i Táº·c" (Vietnamese alt)

â†’ Full-text search trÃªn táº¥t cáº£ titles
```

**Table: `series_stats`** (Denormalized - async update)
| Column | Type | Description |
|--------|------|-------------|
| `series_id` | UUID | FK â†’ series, Primary key |
| `total_views` | BIGINT | Tá»•ng views |
| `weekly_views` | INTEGER | Views 7 ngÃ y gáº§n nháº¥t |
| `monthly_views` | INTEGER | Views 30 ngÃ y gáº§n nháº¥t |
| `followers_count` | INTEGER | Sá»‘ ngÆ°á»i theo dÃµi |
| `chapters_count` | INTEGER | Sá»‘ chapters |
| `rating_avg` | DECIMAL(3,2) | Rating trung bÃ¬nh (1-5) |
| `rating_count` | INTEGER | Sá»‘ lÆ°á»£t Ä‘Ã¡nh giÃ¡ |
| `comments_count` | INTEGER | Tá»•ng comments |
| `last_chapter_at` | TIMESTAMP | Thá»i gian chapter má»›i nháº¥t |
| `updated_at` | TIMESTAMP | |

**Table: `genres`** (Master data)
| Column | Type | Description |
|--------|------|-------------|
| `id` | SMALLINT | Primary key (nhá», Ã­t thay Ä‘á»•i) |
| `name` | VARCHAR(50) | "Action", "Romance", etc. |
| `slug` | VARCHAR(50) | "action", "romance" |
| `description` | TEXT | |

**Table: `series_genres`** (Junction table)
| Column | Type | Description |
|--------|------|-------------|
| `series_id` | UUID | FK â†’ series |
| `genre_id` | SMALLINT | FK â†’ genres |
| PRIMARY KEY | | (series_id, genre_id) |

---

### 1.3 Chapters & Pages (QUAN TRá»ŒNG NHáº¤T)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           CHAPTERS & PAGES DOMAIN                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚  â”‚   series    â”‚                                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
â”‚         â”‚ 1:N                                                                â”‚
â”‚         â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚  chapters   â”‚â”€â”€1:1â”€â”‚chapter_statsâ”‚      â”‚chapter_pricesâ”‚                  â”‚
â”‚  â”‚             â”‚      â”‚  (denorm)   â”‚      â”‚ (premium)   â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚         â”‚ 1:N                                                                â”‚
â”‚         â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                              pages                                   â”‚    â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚    â”‚
â”‚  â”‚  â”‚ Page 1  â”‚  â”‚ Page 2  â”‚  â”‚ Page 3  â”‚  â”‚  ...     â”‚  â”‚ Page N  â”‚   â”‚    â”‚
â”‚  â”‚  â”‚  URLs   â”‚  â”‚  URLs   â”‚  â”‚  URLs   â”‚  â”‚         â”‚  â”‚  URLs   â”‚   â”‚    â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Table: `chapters`**
| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `series_id` | UUID | FK â†’ series, indexed |
| `number` | DECIMAL(10,2) | 1, 1.5, 2, 100.5 (há»— trá»£ chapter láº») |
| `volume` | SMALLINT | Volume number (optional) |
| `title` | VARCHAR(255) | TÃªn chapter (optional) |
| `slug` | VARCHAR(100) | "chapter-1", "chuong-1" |
| `language` | VARCHAR(5) | 'vi', 'en', 'raw' |
| `pages_count` | SMALLINT | Sá»‘ trang (denormalized) |
| `is_premium` | BOOLEAN | Tráº£ phÃ­ hay khÃ´ng |
| `is_published` | BOOLEAN | ÄÃ£ public chÆ°a |
| `uploader_id` | UUID | FK â†’ users |
| `team_id` | UUID | FK â†’ teams (nullable) |
| `source_url` | TEXT | Link gá»‘c (náº¿u cÃ³) |
| `created_at` | TIMESTAMP | |
| `published_at` | TIMESTAMP | Khi nÃ o public |
| `scheduled_at` | TIMESTAMP | Háº¹n giá» Ä‘Äƒng (nullable) |
| UNIQUE | | (series_id, number, language) |

**Index quan trá»ng:**
```sql
-- Query phá»• biáº¿n:  Láº¥y chapters cá»§a 1 series, sáº¯p xáº¿p theo number
CREATE INDEX idx_chapters_series_number 
ON chapters(series_id, number DESC, language);

-- Query: Chapters má»›i nháº¥t
CREATE INDEX idx_chapters_published 
ON chapters(published_at DESC) 
WHERE is_published = true;
```

**Table: `pages`** (Trá»ng tÃ¢m lÆ°u trá»¯ áº£nh)

| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `chapter_id` | UUID | FK â†’ chapters, indexed |
| `page_number` | SMALLINT | 1, 2, 3...  |
| `image_path` | VARCHAR(500) | S3 path:  `series/{id}/chapters/{id}/{page}. webp` |
| `width` | SMALLINT | Pixel width |
| `height` | SMALLINT | Pixel height |
| `file_size` | INTEGER | Bytes |
| `blurhash` | VARCHAR(50) | Blur placeholder hash |
| `created_at` | TIMESTAMP | |
| UNIQUE | | (chapter_id, page_number) |

**Táº¡i sao design nhÆ° váº­y?**

```
âŒ CÃCH SAI:  LÆ°u táº¥t cáº£ page URLs trong 1 JSONB column cá»§a chapters
   chapters. pages = ["url1", "url2", ...]
   
   Váº¥n Ä‘á»: 
   â”œâ”€â”€ KhÃ´ng query Ä‘Æ°á»£c tá»«ng page
   â”œâ”€â”€ Update 1 page = rewrite toÃ n bá»™ array
   â”œâ”€â”€ KhÃ´ng cÃ³ metadata per page (width, height)
   â””â”€â”€ JSONB indexes kÃ©m hiá»‡u quáº£

âœ… CÃCH ÄÃšNG: Má»—i page lÃ  1 row riÃªng
   
   Æ¯u Ä‘iá»ƒm:
   â”œâ”€â”€ Query tá»«ng page dá»… dÃ ng
   â”œâ”€â”€ Update atomic
   â”œâ”€â”€ CÃ³ Ä‘áº§y Ä‘á»§ metadata
   â”œâ”€â”€ Parallel loading possible
   â””â”€â”€ Dá»… implement lazy loading
```

**Table: `chapter_stats`** (Denormalized)
| Column | Type | Description |
|--------|------|-------------|
| `chapter_id` | UUID | FK â†’ chapters, Primary key |
| `views_count` | BIGINT | |
| `comments_count` | INTEGER | |
| `likes_count` | INTEGER | |
| `updated_at` | TIMESTAMP | |

**Table: `chapter_prices`** (Premium chapters)
| Column | Type | Description |
|--------|------|-------------|
| `chapter_id` | UUID | FK â†’ chapters, Primary key |
| `price_coins` | INTEGER | GiÃ¡ báº±ng xu |
| `discount_percent` | SMALLINT | % giáº£m giÃ¡ (0-100) |
| `discount_until` | TIMESTAMP | Háº¿t háº¡n giáº£m giÃ¡ |
| `free_after` | TIMESTAMP | Miá»…n phÃ­ sau ngÃ y nÃ y |

---

### 1.4 URL Strategy (Quan trá»ng!)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           IMAGE URL STRATEGY                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  S3 BUCKET STRUCTURE:                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                        â”‚
â”‚  mangahub-content/                                                           â”‚
â”‚  â”œâ”€â”€ series/                                                                 â”‚
â”‚  â”‚   â”œâ”€â”€ {series_uuid}/                                                      â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ cover.webp                                                      â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ banner.webp                                                     â”‚
â”‚  â”‚   â”‚   â””â”€â”€ chapters/                                                       â”‚
â”‚  â”‚   â”‚       â”œâ”€â”€ {chapter_uuid}/                                             â”‚
â”‚  â”‚   â”‚       â”‚   â”œâ”€â”€ 001.webp                                                â”‚
â”‚  â”‚   â”‚       â”‚   â”œâ”€â”€ 002.webp                                                â”‚
â”‚  â”‚   â”‚       â”‚   â”œâ”€â”€ 003.webp                                                â”‚
â”‚  â”‚   â”‚       â”‚   â””â”€â”€ ...                                                     â”‚
â”‚  â”‚   â”‚       â””â”€â”€ {chapter_uuid}/                                             â”‚
â”‚  â”‚   â””â”€â”€ {series_uuid}/                                                      â”‚
â”‚  â””â”€â”€ users/                                                                  â”‚
â”‚      â””â”€â”€ {user_uuid}/                                                        â”‚
â”‚          â””â”€â”€ avatar.webp                                                     â”‚
â”‚                                                                              â”‚
â”‚  DATABASE LÆ¯U:                                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                               â”‚
â”‚  pages. image_path = "series/{uuid}/chapters/{uuid}/001.webp"                â”‚
â”‚                                                                              â”‚
â”‚  KHÃ”NG LÆ¯U: Full URL (https://s3.../bucket/...)                             â”‚
â”‚  Táº I SAO:  Dá»… migrate giá»¯a S3 providers, Ä‘á»•i CDN domain                     â”‚
â”‚                                                                              â”‚
â”‚  FRONTEND Sá»¬ Dá»¤NG:                                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
â”‚  const imageUrl = `${CDN_BASE}/${page.image_path}`                          â”‚
â”‚  hoáº·c qua Imgproxy:                                                           â”‚
â”‚  const imageUrl = `${IMGPROXY_URL}/resize: 800/plain/s3://${page.image_path}`â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Naming Convention:**

```
Táº¡i sao dÃ¹ng UUID folder thay vÃ¬ slug?
â”œâ”€â”€ Slug cÃ³ thá»ƒ thay Ä‘á»•i â†’ broken links
â”œâ”€â”€ UUID immutable â†’ URLs á»•n Ä‘á»‹nh mÃ£i mÃ£i
â”œâ”€â”€ UUID unique â†’ khÃ´ng conflict
â””â”€â”€ Slug váº«n dÃ¹ng cho URL thÃ¢n thiá»‡n ngÆ°á»i dÃ¹ng

URL cho ngÆ°á»i dÃ¹ng:  /truyen/one-piece/chapter-1
NhÆ°ng internally: /series/abc-123-uuid/chapters/def-456-uuid/

Táº¡i sao page lÃ  001.webp thay vÃ¬ 1.webp?
â”œâ”€â”€ Sorting Ä‘Ãºng:  001, 002, .. ., 010, 011
â”œâ”€â”€ Náº¿u dÃ¹ng 1, 2: 1, 10, 11, 2, 20 (sai)
â””â”€â”€ 3 digits há»— trá»£ tá»›i 999 pages/chapter
```

---

## 2. SOCIAL & INTERACTION ENTITIES

### 2.1 Following & Bookmarks

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           SOCIAL INTERACTIONS                                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚   users     â”‚                     â”‚   series    â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚         â”‚                                   â”‚                                â”‚
â”‚         â”‚ N:M                               â”‚ N:M                            â”‚
â”‚         â–¼                                   â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚user_follows â”‚                     â”‚series_followsâ”‚                        â”‚
â”‚  â”‚(userâ†’user)  â”‚                     â”‚(userâ†’series)â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                             â”‚                                â”‚
â”‚                                             â”‚                                â”‚
â”‚                                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                                      â”‚reading_     â”‚                        â”‚
â”‚                                      â”‚progress     â”‚                        â”‚
â”‚                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Table: `series_follows`** (Theo dÃµi truyá»‡n)
| Column | Type | Description |
|--------|------|-------------|
| `user_id` | UUID | FK â†’ users |
| `series_id` | UUID | FK â†’ series |
| `notify` | BOOLEAN | Nháº­n thÃ´ng bÃ¡o chapter má»›i |
| `created_at` | TIMESTAMP | |
| PRIMARY KEY | | (user_id, series_id) |

**Index:**
```sql
-- User's following list
CREATE INDEX idx_series_follows_user 
ON series_follows(user_id, created_at DESC);

-- Series's followers count
CREATE INDEX idx_series_follows_series 
ON series_follows(series_id);
```

**Table: `reading_progress`** (Tiáº¿n Ä‘á»™ Ä‘á»c)
| Column | Type | Description |
|--------|------|-------------|
| `user_id` | UUID | FK â†’ users |
| `series_id` | UUID | FK â†’ series |
| `last_chapter_id` | UUID | FK â†’ chapters |
| `last_page_number` | SMALLINT | Trang cuá»‘i Ä‘á»c |
| `progress_percent` | SMALLINT | % hoÃ n thÃ nh series |
| `started_at` | TIMESTAMP | Báº¯t Ä‘áº§u Ä‘á»c |
| `updated_at` | TIMESTAMP | Láº§n Ä‘á»c gáº§n nháº¥t |
| PRIMARY KEY | | (user_id, series_id) |

**Table: `reading_history`** (Chi tiáº¿t tá»«ng láº§n Ä‘á»c)
| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `user_id` | UUID | FK â†’ users |
| `chapter_id` | UUID | FK â†’ chapters |
| `started_at` | TIMESTAMP | Báº¯t Ä‘áº§u Ä‘á»c chapter |
| `finished_at` | TIMESTAMP | Äá»c xong (nullable) |
| `pages_read` | SMALLINT | Sá»‘ trang Ä‘Ã£ Ä‘á»c |

**Táº¡i sao cáº§n cáº£ 2 tables?**
```
reading_progress:  Tráº¡ng thÃ¡i hiá»‡n táº¡i (1 row per series per user)
â”œâ”€â”€ DÃ¹ng cho "Continue Reading" button
â”œâ”€â”€ DÃ¹ng cho progress bar
â””â”€â”€ Query nhanh

reading_history: Lá»‹ch sá»­ chi tiáº¿t (nhiá»u rows)
â”œâ”€â”€ Analytics:  user Ä‘á»c vÃ o giá» nÃ o
â”œâ”€â”€ "ÄÃ£ Ä‘á»c gáº§n Ä‘Ã¢y" list
â””â”€â”€ Behavior tracking
```

---

### 2.2 Ratings & Comments

**Table: `series_ratings`**
| Column | Type | Description |
|--------|------|-------------|
| `user_id` | UUID | FK â†’ users |
| `series_id` | UUID | FK â†’ series |
| `score` | SMALLINT | 1-5 hoáº·c 1-10 |
| `created_at` | TIMESTAMP | |
| `updated_at` | TIMESTAMP | |
| PRIMARY KEY | | (user_id, series_id) |

**Table: `comments`** (Polymorphic - dÃ¹ng cho nhiá»u entity)
| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `user_id` | UUID | FK â†’ users |
| `entity_type` | ENUM | 'series', 'chapter' |
| `entity_id` | UUID | ID cá»§a series hoáº·c chapter |
| `parent_id` | UUID | FK â†’ comments (reply) |
| `content` | TEXT | Ná»™i dung comment |
| `likes_count` | INTEGER | Denormalized |
| `replies_count` | INTEGER | Denormalized |
| `is_pinned` | BOOLEAN | Ghim comment |
| `is_hidden` | BOOLEAN | áº¨n (moderation) |
| `created_at` | TIMESTAMP | |
| `updated_at` | TIMESTAMP | |

**Index:**
```sql
-- Comments cá»§a 1 chapter, má»›i nháº¥t trÆ°á»›c
CREATE INDEX idx_comments_entity 
ON comments(entity_type, entity_id, created_at DESC)
WHERE is_hidden = false;

-- Replies cá»§a 1 comment
CREATE INDEX idx_comments_parent 
ON comments(parent_id, created_at ASC)
WHERE parent_id IS NOT NULL;
```

---

## 3. COMMERCE ENTITIES (Wallet & Payments)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           COMMERCE DOMAIN                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚   users     â”‚â”€â”€1:1â”€â”‚   wallets   â”‚â”€â”€1:Nâ”€â”‚ledger_entriesâ”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                              â”‚                                               â”‚
â”‚                              â”‚ 1:N                                           â”‚
â”‚                              â–¼                                               â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚                       â”‚transactions â”‚â”€â”€N:1â”€â”‚payment_     â”‚                  â”‚
â”‚                       â”‚             â”‚      â”‚methods      â”‚                  â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                              â”‚                                               â”‚
â”‚                              â”‚                                               â”‚
â”‚                              â–¼                                               â”‚
â”‚                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                       â”‚
â”‚                       â”‚chapter_     â”‚                                       â”‚
â”‚                       â”‚purchases    â”‚                                       â”‚
â”‚                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Table: `wallets`**
| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `user_id` | UUID | FK â†’ users, UNIQUE |
| `balance` | BIGINT | Sá»‘ xu hiá»‡n táº¡i (KHÃ”NG ÄÆ¯á»¢C Ã‚M) |
| `total_deposited` | BIGINT | Tá»•ng náº¡p |
| `total_spent` | BIGINT | Tá»•ng tiÃªu |
| `currency` | VARCHAR(10) | 'COIN', 'VND' |
| `created_at` | TIMESTAMP | |
| `updated_at` | TIMESTAMP | |

**Constraint quan trá»ng:**
```sql
ALTER TABLE wallets 
ADD CONSTRAINT positive_balance CHECK (balance >= 0);
```

**Table: `ledger_entries`** (Double-Entry Bookkeeping)
| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `transaction_id` | UUID | Group entries cá»§a cÃ¹ng 1 transaction |
| `wallet_id` | UUID | FK â†’ wallets |
| `entry_type` | ENUM | 'DEBIT' (trá»«), 'CREDIT' (cá»™ng) |
| `amount` | BIGINT | Sá»‘ tiá»n (luÃ´n dÆ°Æ¡ng) |
| `balance_after` | BIGINT | Sá»‘ dÆ° sau transaction |
| `description` | VARCHAR(255) | "Mua chapter One Piece #100" |
| `reference_type` | VARCHAR(50) | 'chapter_purchase', 'topup', 'refund' |
| `reference_id` | UUID | ID cá»§a entity liÃªn quan |
| `created_at` | TIMESTAMP | |

**VÃ­ dá»¥ Double-Entry:**
```
User A mua chapter (20 xu):

ledger_entries: 
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚transaction_idâ”‚   wallet_id    â”‚ type  â”‚ amount â”‚ balance_after â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ txn-001      â”‚ user_A_wallet  â”‚ DEBIT â”‚   20   â”‚     80        â”‚
â”‚ txn-001      â”‚ system_revenue â”‚ CREDITâ”‚   20   â”‚    1020       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Verify:  SUM(DEBIT) = SUM(CREDIT) = 20 âœ“
```

**Table: `transactions`** (Payment records)
| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `user_id` | UUID | FK â†’ users |
| `type` | ENUM | 'topup', 'purchase', 'refund', 'reward' |
| `status` | ENUM | 'pending', 'completed', 'failed', 'cancelled' |
| `amount_coins` | INTEGER | Sá»‘ xu |
| `amount_money` | BIGINT | Sá»‘ tiá»n VND (náº¿u topup) |
| `payment_method` | VARCHAR(50) | 'momo', 'vnpay', 'bank_transfer' |
| `payment_ref` | VARCHAR(255) | MÃ£ giao dï¿½ï¿½ch tá»« payment gateway |
| `metadata` | JSONB | Chi tiáº¿t bá»• sung |
| `created_at` | TIMESTAMP | |
| `completed_at` | TIMESTAMP | |
| `expires_at` | TIMESTAMP | Háº¿t háº¡n thanh toÃ¡n |

**Table: `chapter_purchases`**
| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `user_id` | UUID | FK â†’ users |
| `chapter_id` | UUID | FK â†’ chapters |
| `transaction_id` | UUID | FK â†’ transactions |
| `price_paid` | INTEGER | GiÃ¡ lÃºc mua (cÃ³ thá»ƒ khÃ¡c giÃ¡ hiá»‡n táº¡i) |
| `purchased_at` | TIMESTAMP | |
| UNIQUE | | (user_id, chapter_id) |

---

## 4. TEAM & COLLABORATION ENTITIES

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           TEAMS DOMAIN                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚   teams     â”‚â”€â”€â”€â”€â”€â”€1:Nâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚team_members â”‚                        â”‚
â”‚  â”‚             â”‚                     â”‚             â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚         â”‚                                   â”‚                                â”‚
â”‚         â”‚ 1:N                               â”‚ N:1                            â”‚
â”‚         â–¼                                   â–¼                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚  projects   â”‚                     â”‚   users     â”‚                        â”‚
â”‚  â”‚(series work)â”‚                     â”‚             â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚         â”‚                                                                    â”‚
â”‚         â”‚ 1:N                                                                â”‚
â”‚         â–¼                                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                            â”‚
â”‚  â”‚chapter_     â”‚                                                            â”‚
â”‚  â”‚credits      â”‚                                                            â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                            â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Table: `teams`** (NhÃ³m scanlation)
| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `name` | VARCHAR(100) | Unique |
| `slug` | VARCHAR(100) | URL-safe, unique |
| `description` | TEXT | |
| `logo_url` | TEXT | |
| `banner_url` | TEXT | |
| `website` | VARCHAR(255) | |
| `discord_url` | VARCHAR(255) | |
| `is_verified` | BOOLEAN | XÃ¡c thá»±c chÃ­nh thá»©c |
| `is_recruiting` | BOOLEAN | Äang tuyá»ƒn thÃ nh viÃªn |
| `owner_id` | UUID | FK â†’ users |
| `created_at` | TIMESTAMP | |

**Table: `team_members`**
| Column | Type | Description |
|--------|------|-------------|
| `team_id` | UUID | FK â†’ teams |
| `user_id` | UUID | FK â†’ users |
| `role` | ENUM | 'owner', 'admin', 'translator', 'editor', 'proofreader', 'member' |
| `joined_at` | TIMESTAMP | |
| PRIMARY KEY | | (team_id, user_id) |

**Table: `chapter_credits`** (Ghi nháº­n Ä‘Ã³ng gÃ³p)
| Column | Type | Description |
|--------|------|-------------|
| `id` | UUID | Primary key |
| `chapter_id` | UUID | FK â†’ chapters |
| `user_id` | UUID | FK â†’ users (nullable) |
| `team_id` | UUID | FK â†’ teams (nullable) |
| `role` | ENUM | 'translator', 'editor', 'proofreader', 'cleaner', 'typesetter', 'raw_provider', 'quality_check' |
| `note` | VARCHAR(255) | Ghi chÃº thÃªm |

---

## 5. VIEWS & ANALYTICS (Redis + PostgreSQL)

### Strategy:  Hybrid Approach

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        VIEWS COUNTING STRATEGY                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  REAL-TIME (Redis):                                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  HyperLogLog:  Unique views                                             â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ PFADD views: chapter:{id}:daily:{date} {user_ip}                  â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ PFADD views:series:{id}: daily:{date} {user_ip}                   â”‚  â”‚
â”‚  â”‚  â””â”€â”€ PFCOUNT views:chapter:{id}:daily: 2024-01-15                      â”‚  â”‚
â”‚  â”‚                                                                        â”‚  â”‚
â”‚  â”‚  Sorted Sets:  Rankings                                                 â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ ZINCRBY rankings:daily {score} {series_id}                       â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ ZINCRBY rankings:weekly {score} {series_id}                      â”‚  â”‚
â”‚  â”‚  â””â”€â”€ ZREVRANGE rankings:daily 0 9 WITHSCORES (Top 10)                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â”‚  PERSISTENT (PostgreSQL):                                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Cronjob má»—i 10 phÃºt:                                                   â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ Sync Redis counters â†’ series_stats, chapter_stats                â”‚  â”‚
â”‚  â”‚  â””â”€â”€ Archive Redis data sau 7 ngÃ y â†’ analytics_daily table            â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Table: `analytics_daily`** (Historical data)
| Column | Type | Description |
|--------|------|-------------|
| `id` | BIGSERIAL | Primary key |
| `date` | DATE | NgÃ y |
| `entity_type` | VARCHAR(20) | 'series', 'chapter' |
| `entity_id` | UUID | |
| `views` | INTEGER | Sá»‘ views trong ngÃ y |
| `unique_views` | INTEGER | Unique visitors |
| `new_followers` | INTEGER | Follows má»›i |
| `comments` | INTEGER | Comments má»›i |
| PRIMARY KEY | | (date, entity_type, entity_id) |

---

## 6. FULL SCHEMA DIAGRAM

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    COMPLETE SCHEMA                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                          â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”‚
â”‚                              â”‚       users         â”‚                                    â”‚
â”‚                              â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                                    â”‚
â”‚                              â”‚  id, email, role    â”‚                                    â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚          â”‚                       â”‚             â”‚                       â”‚               â”‚
â”‚          â–¼                       â–¼             â–¼                       â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚user_profiles â”‚        â”‚  wallets    â”‚ â”‚  teams   â”‚         â”‚series_followsâ”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                 â”‚             â”‚                       â”‚               â”‚
â”‚                                 â–¼             â–¼                       â”‚               â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚               â”‚
â”‚                          â”‚ledger_entriesâ”‚ â”‚team_members â”‚             â”‚               â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚               â”‚
â”‚                                                                       â”‚               â”‚
â”‚                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚               â”‚
â”‚                              â”‚       series        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                              â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚                                    â”‚
â”‚                              â”‚  id, title, slug    â”‚                                    â”‚
â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                    â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ï¿½ï¿½ï¿½â”€â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚          â”‚                       â”‚             â”‚                       â”‚               â”‚
â”‚          â–¼                       â–¼             â–¼                       â–¼               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚series_stats  â”‚        â”‚series_genresâ”‚ â”‚series_alt_   â”‚      â”‚   chapters   â”‚        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚titles        â”‚      â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚        â”‚
â”‚                                 â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚  id, number  â”‚        â”‚
â”‚                                 â–¼                              â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                               â”‚               â”‚
â”‚                          â”‚   genres    â”‚                               â”‚               â”‚
â”‚                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                               â”‚               â”‚
â”‚                                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚                                                          â”‚             â”‚             â”‚ â”‚
â”‚                                                          â–¼             â–¼             â–¼ â”‚
â”‚                                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                   â”‚   pages   â”‚ â”‚chapter_statsâ”‚ â”‚chapter_ â”‚
â”‚                                                   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚purchasesâ”‚
â”‚                                                   â”‚ image_pathâ”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. QUERY PATTERNS & INDEXES

### CÃ¡c Query Phá»• biáº¿n nháº¥t

**1. Homepage - Latest Updates:**
```sql
-- Láº¥y 20 chapters má»›i nháº¥t vá»›i series info
SELECT c.id, c. number, c.title, c.published_at,
       s.id as series_id, s.title as series_title, s.slug, s.cover_url
FROM chapters c
JOIN series s ON s.id = c.series_id
WHERE c.is_published = true
ORDER BY c.published_at DESC
LIMIT 20;

-- Index cáº§n: 
CREATE INDEX idx_chapters_latest 
ON chapters(published_at DESC) 
WHERE is_published = true
INCLUDE (series_id, number, title);
```

**2. Series Detail Page:**
```sql
-- Series info + stats + chapters list
SELECT s.*, ss.total_views, ss.followers_count, ss.rating_avg
FROM series s
JOIN series_stats ss ON ss.series_id = s.id
WHERE s.slug = 'one-piece';

-- Chapters cá»§a series
SELECT c.id, c.number, c.title, c.published_at, c.pages_count,
       cs.views_count
FROM chapters c
LEFT JOIN chapter_stats cs ON cs.chapter_id = c.id
WHERE c.series_id = ?  AND c.is_published = true
ORDER BY c.number DESC;
```

**3. Reading Page:**
```sql
-- Láº¥y pages cá»§a chapter
SELECT id, page_number, image_path, width, height, blurhash
FROM pages
WHERE chapter_id = ? 
ORDER BY page_number ASC;

-- Index: 
CREATE INDEX idx_pages_chapter 
ON pages(chapter_id, page_number);
```

**4. User's Library:**
```sql
-- Truyá»‡n Ä‘ang theo dÃµi + progress
SELECT s.id, s.title, s.slug, s.cover_url,
       rp.last_chapter_id, rp.progress_percent, rp.updated_at,
       c.number as last_read_chapter
FROM series_follows sf
JOIN series s ON s.id = sf.series_id
LEFT JOIN reading_progress rp ON rp.series_id = s. id AND rp.user_id = sf.user_id
LEFT JOIN chapters c ON c.id = rp.last_chapter_id
WHERE sf. user_id = ?
ORDER BY COALESCE(rp.updated_at, sf.created_at) DESC;
```

**5. Rankings:**
```sql
-- Top trending (dá»±a vÃ o weekly views)
SELECT s.id, s.title, s.slug, s.cover_url,
       ss.weekly_views, ss.rating_avg
FROM series s
JOIN series_stats ss ON ss.series_id = s.id
WHERE s.visibility = 'public'
ORDER BY ss.weekly_views DESC
LIMIT 10;

-- Index:
CREATE INDEX idx_series_stats_ranking 
ON series_stats(weekly_views DESC);
```

---

## 8. MIGRATION STRATEGY

### Tá»« Schema hiá»‡n táº¡i â†’ Schema má»›i

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MIGRATION PHASES                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                              â”‚
â”‚  Phase 1: Non-breaking additions (CÃ³ thá»ƒ deploy ngay)                       â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                      â”‚
â”‚  â”œâ”€â”€ ThÃªm tables má»›i:  wallets, ledger_entries, transactions                â”‚
â”‚  â”œâ”€â”€ ThÃªm tables má»›i: series_stats, chapter_stats, user_stats              â”‚
â”‚  â”œâ”€â”€ ThÃªm columns má»›i vÃ o existing tables                                   â”‚
â”‚  â””â”€â”€ Táº¡o indexes má»›i                                                         â”‚
â”‚                                                                              â”‚
â”‚  Phase 2: Data migration (Background job)                                   â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â”œâ”€â”€ Populate series_stats tá»« existing data                                 â”‚
â”‚  â”œâ”€â”€ Create wallets cho existing users                                      â”‚
â”‚  â”œâ”€â”€ Migrate reading history                                                 â”‚
â”‚  â””â”€â”€ Verify data integrity                                                   â”‚
â”‚                                                                              â”‚
â”‚  Phase 3: Code updates (Gradual rollout)                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                  â”‚
â”‚  â”œâ”€â”€ Update queries to use new tables                                       â”‚
â”‚  â”œâ”€â”€ Feature flags for new commerce features                                â”‚
â”‚  â””â”€â”€ Deprecate old columns/tables                                            â”‚
â”‚                                                                              â”‚
â”‚  Phase 4: Cleanup (After validation)                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€                                       â”‚
â”‚  â”œâ”€â”€ Drop deprecated columns                                                 â”‚
â”‚  â”œâ”€â”€ Drop deprecated indexes                                                 â”‚
â”‚  â””â”€â”€ Final optimization                                                      â”‚
â”‚                                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 9. TÃ“M Táº®T BEST PRACTICES

| Aspect | Recommendation |
|--------|----------------|
| **Primary Keys** | UUID v4 (distributed-friendly) |
| **Timestamps** | TIMESTAMPTZ (timezone-aware) |
| **Money/Balance** | BIGINT (khÃ´ng dÃ¹ng DECIMAL Ä‘á»ƒ trÃ¡nh floating point) |
| **URLs/Paths** | LÆ°u relative path, khÃ´ng lÆ°u full URL |
| **Counters** | Denormalize vÃ o *_stats tables, async update |
| **Soft Delete** | `deleted_at` column thay vÃ¬ DELETE |
| **Audit** | `created_at`, `updated_at` má»i table |
| **Enums** | PostgreSQL ENUM type (type-safe) |
| **JSON Data** | JSONB vá»›i GIN index |
| **Full-text Search** | pg_trgm extension + GIN indexes |

---

**Káº¿t luáº­n:**  Schema nÃ y Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ: 
1. âœ… Handle millions of pages efficiently
2. âœ… Support premium/freemium model
3. âœ… Scale horizontally (UUID, denormalization)
4. âœ… Fast reads (strategic indexes, caching)
5. âœ… Audit-friendly (double-entry bookkeeping)
6. âœ… Flexible (JSONB for extensibility)